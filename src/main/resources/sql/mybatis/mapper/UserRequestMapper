<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.tus.wndflwr.repository.UserRequestMapper">

	<insert id="createTableUserRequest">
		CREATE TABLE IF NOT EXISTS tus_user_request (
			user_request_seq INT PRIMARY KEY
			, username VARCHAR(255) NOT NULL
			, password VARCHAR(255) NOT NULL
			, email VARCHAR(255) NOT NULL
			, request_date TIMESTAMP NOT NULL
			, status VARCHAR(10) DEFAULT 'REQUESTED'
			, mod_date TIMESTAMP
		);
		CREATE INDEX IF NOT EXISTS idx_user_request_username ON tus_user_request (username);
		CREATE SEQUENCE IF NOT EXISTS seq_user_request_seq
			START WITH 1000
			INCREMENT BY 1
			MINVALUE 100000000
			MAXVALUE 2147483647
			NOCYCLE
		;
	</insert>

	<insert id="createTableUserIpRequest">
		CREATE TABLE IF NOT EXISTS tus_user_ip_request (
			username VARCHAR(255) NOT NULL
			, type VARCHAR(4) NOT NULL
			, ip VARCHAR(100) NOT NULL
		);
		CREATE INDEX IF NOT EXISTS idx_user_ip_request_username ON tus_user_ip_request(username);
	</insert>

	<insert id="insertUserRequest">
		INSERT INTO tus_user_request (
			user_request_seq
			, username
			, password
			, email
			, request_date
			, status
			, approved_date
		) VALUES (
			seq_user_request_seq.NEXTVAL
			, #{username}
			, #{password}
			, #{email}
			, SYSDATE
			, 'REQUESTED'
			, SYSDATE
		)
		<selectKey resultType="int" order="AFTER">
			SELECT seq_user_request_seq.CURRVAL FROM DUAL
		</selectKey>
	</insert>
</mapper>
